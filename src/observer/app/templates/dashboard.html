<!-- observer/app/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Eye of Odin - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Project Eye of Odin</h1>
            <div class="mt-2 text-sm text-gray-600">
                <span id="connection-status" class="mr-4">
                    Status: <span class="font-semibold text-green-600">Connected</span>
                </span>
                <span id="client-count">
                    Clients: Camera (0), LiDAR (0)
                </span>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Camera Feeds -->
            <div class="bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-xl font-semibold mb-4">Camera Feed</h2>
                <div class="relative aspect-video bg-gray-200">
                    <img id="camera-feed" class="w-full h-full object-contain" alt="No camera feed available">
                    <div id="camera-overlay" class="absolute top-0 left-0 p-2 text-sm text-white bg-black bg-opacity-50">
                        FPS: <span id="camera-fps">0</span>
                    </div>
                </div>
            </div>

            <!-- LiDAR Visualization -->
            <div class="bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-xl font-semibold mb-4">LiDAR Data</h2>
                <div id="lidar-plot" class="w-full aspect-video"></div>
            </div>

            <!-- System Status -->
            <div class="bg-white rounded-lg shadow-lg p-4 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">System Status</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">Camera FPS</div>
                        <div id="stats-fps" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">LiDAR Points</div>
                        <div id="stats-points" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">Latency</div>
                        <div id="stats-latency" class="text-2xl font-bold">0 ms</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">Status</div>
                        <div id="stats-status" class="text-2xl font-bold text-green-600">OK</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="text/javascript">
        // WebSocket 연결
        let cameraWs = null;
        let lidarWs = null;
        let lastFrameTime = 0;
        let frameCount = 0;

        // 카메라 WebSocket 초기화
        function initCameraWebSocket() {
            cameraWs = new WebSocket(`ws://${window.location.host}/ws/camera`);
            
            cameraWs.onmessage = function(event) {
                if (event.data instanceof Blob) {
                    // 이미지 데이터 처리
                    const url = URL.createObjectURL(event.data);
                    document.getElementById('camera-feed').src = url;
                    
                    // FPS 계산
                    frameCount++;
                    const now = performance.now();
                    if (now - lastFrameTime >= 1000) {
                        document.getElementById('camera-fps').textContent = frameCount;
                        document.getElementById('stats-fps').textContent = frameCount;
                        frameCount = 0;
                        lastFrameTime = now;
                    }
                } else {
                    // JSON 메타데이터 처리
                    const metadata = JSON.parse(event.data);
                    // 메타데이터 활용 (필요시)
                }
            };
        }

        // LiDAR WebSocket 초기화
        function initLidarWebSocket() {
            lidarWs = new WebSocket(`ws://${window.location.host}/ws/lidar`);
            
            lidarWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // LiDAR 데이터 시각화
                const ranges = data.data.ranges;
                const angles = Array.from({length: ranges.length}, (_, i) => 
                    i * (data.data.angle_increment * 180/Math.PI)
                );

                const plotData = [{
                    type: 'scatterpolar',
                    r: ranges,
                    theta: angles,
                    mode: 'markers',
                    marker: {
                        size: 3,
                        color: ranges,
                        colorscale: 'Viridis'
                    }
                }];

                const layout = {
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, data.data.range_max]
                        }
                    },
                    showlegend: false,
                    margin: {t: 0, b: 0, l: 0, r: 0}
                };

                Plotly.newPlot('lidar-plot', plotData, layout);
                
                // 통계 업데이트
                document.getElementById('stats-points').textContent = ranges.filter(r => r > 0).length;
            };
        }

        // 연결 시작
        initCameraWebSocket();
        initLidarWebSocket();

        // 상태 업데이트 폴링
        setInterval(async () => {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                document.getElementById('client-count').textContent = 
                    `Clients: Camera (${status.connected_clients.camera || 0}), LiDAR (${status.connected_clients.lidar || 0})`;
            } catch (error) {
                console.error('Status update failed:', error);
            }
        }, 1000);
    </script>
</body>
</html>